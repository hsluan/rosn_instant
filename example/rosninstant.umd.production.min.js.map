{"version":3,"file":"rosninstant.umd.production.min.js","sources":["../src/event-wrapper.ts","../src/platform.ts","../src/component/ScriptDownloader.ts","../src/component/NetworkMgr.ts","../src/index.ts"],"sourcesContent":["// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport type Listener = (payload: any) => void\r\nexport interface EventManager {\r\n  add(eventName: string, listener: Listener): void\r\n  remove(eventName: string, listener: Listener): void\r\n}\r\n\r\nexport class EventWrapper {\r\n  listeners: Map<string, Listener> = new Map()\r\n  listenerManager: EventManager\r\n\r\n  constructor(listenerManager: EventManager) {\r\n    this.listenerManager = listenerManager\r\n  }\r\n\r\n  addListener(eventName: string, listener: Listener): void {\r\n    this.listeners.set(eventName, listener)\r\n    this.listenerManager.add(eventName, listener)\r\n  }\r\n\r\n  removeListener(eventName: string): void {\r\n    const listener = this.listeners.get(eventName)\r\n    if (!listener) {\r\n      return\r\n    }\r\n\r\n    this.listenerManager.remove(eventName, listener)\r\n    this.listeners.delete(eventName)\r\n  }\r\n\r\n  on(eventName: string, listener: Listener): void {\r\n    // Remove previous listener\r\n    this.removeListener(eventName)\r\n\r\n    // Add new listener\r\n    this.addListener(eventName, listener)\r\n  }\r\n\r\n  once(eventName: string, listener: Listener): void {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const onceWrapper = (payload: any) => {\r\n      listener(payload)\r\n      this.removeListener(eventName)\r\n    }\r\n    this.addListener(eventName, onceWrapper)\r\n  }\r\n\r\n  off(eventName: string): void {\r\n    if (!this.listeners.has(eventName)) {\r\n      return\r\n    }\r\n\r\n    this.removeListener(eventName)\r\n  }\r\n\r\n  clear(): void {\r\n    this.listeners.forEach((value, key) => {\r\n      this.listenerManager.remove(key, value)\r\n    })\r\n    this.listeners.clear()\r\n  }\r\n}\r\n","import { AdsConfig } from 'defines/alldefines'\r\nimport { EventWrapper } from './event-wrapper'\r\n\r\ndeclare class RApp {\r\n  static postMessage(msg: any): void\r\n}\r\n\r\nfunction emit(\r\n  eventName: string,\r\n  source: string,\r\n  payload: any | null = null\r\n): void {\r\n  const message = { type: eventName, source, data: payload || {} }\r\n  //eslint-disable-next-line no-undef\r\n  if (typeof RApp !== 'undefined') {\r\n    RApp.postMessage(JSON.stringify(message))\r\n  } else {\r\n    // eslint-disable-next-line no-console\r\n    console.log(`emit: ${JSON.stringify(message)}`)\r\n  }\r\n}\r\n\r\nexport class Platform {\r\n  private source: string\r\n  private eventWrapper: EventWrapper = new EventWrapper({\r\n    add(eventName: string, listener: (payload: any) => void): void {\r\n      window.document.addEventListener(eventName, listener)\r\n    },\r\n    remove(eventName: string, listener: (payload: any) => void): void {\r\n      window.document.removeEventListener(eventName, listener)\r\n    },\r\n  })\r\n\r\n  constructor(source: string) {\r\n    this.source = source\r\n  }\r\n\r\n  showAds(config: AdsConfig): void {\r\n    emit(`show_${config.adsType}_ads`, this.source, { ...config })\r\n  }\r\n\r\n  startGame(): void {\r\n    emit('request_game_data', this.source)\r\n  }\r\n\r\n  emitCustomEvent(eventName: string, payload: any) {\r\n    emit(eventName, this.source, payload)\r\n  }\r\n\r\n  on(eventName: string, listener: (payload: any) => void): void {\r\n    this.eventWrapper.on(eventName, this.transform(listener))\r\n  }\r\n\r\n  off(eventName: string): void {\r\n    this.eventWrapper.off(eventName)\r\n  }\r\n\r\n  once(eventName: string, listener: (payload: any) => void): void {\r\n    this.eventWrapper.once(eventName, this.transform(listener))\r\n  }\r\n\r\n  clear(): void {\r\n    this.eventWrapper.clear()\r\n  }\r\n\r\n  transform(listener: (payload: any) => void): (payload: any) => void {\r\n    const transformedListener = (event: any) => {\r\n      if (event.detail) {\r\n        if (typeof event.detail === 'string') listener(JSON.parse(event.detail))\r\n        else listener(event.detail)\r\n      } else {\r\n        listener({\r\n          detail: {},\r\n          message: 'Detail NULL',\r\n        })\r\n      }\r\n    }\r\n    return transformedListener\r\n  }\r\n}\r\n","export default class ScriptDownloader {\n  private static downloaded: any = {}\n\n  //eslint-disable-next-line no-undef\n  private static parseParameters(\n    options: Function | any,\n    onProgress: Function | any,\n    onComplete: Function | any\n  ) {\n    if (onComplete === undefined) {\n      var isCallback = typeof options === 'function'\n      if (onProgress) {\n        onComplete = onProgress\n        if (!isCallback) {\n          onProgress = null\n        }\n      } else if (onProgress === null && isCallback) {\n        onComplete = options\n        options = null\n        onProgress = null\n      }\n      if (onProgress !== null && isCallback) {\n        onProgress = options\n        options = null\n      }\n    }\n    options = options || Object.create(null)\n    return { options, onProgress, onComplete }\n  }\n\n  public static downloadScript(url: string) {\n    return ScriptDownloader.downloadScriptWeb(url)\n  }\n  private static downloadScriptWeb(url: string): Promise<void> {\n    let promise = new Promise<void>((resolve, reject) => {\n      var { options, onComplete } = ScriptDownloader.parseParameters(\n        options,\n        null,\n        onComplete\n      )\n\n      // no need to load script again\n      if (ScriptDownloader.downloaded[url]) {\n        resolve()\n        return\n      }\n\n      let d = document\n      let s = document.createElement('script')\n\n      // if (window.location.protocol !== 'file:') {\n      //   s.crossOrigin = 'anonymous'\n      // }\n\n      s.async = options.async\n      s.src = url\n      let loadHandler = () => {\n        s.parentNode?.removeChild(s)\n        s.removeEventListener('load', loadHandler, false)\n        s.removeEventListener('error', errorHandler, false)\n        ScriptDownloader.downloaded[url] = true\n        resolve()\n      }\n\n      let errorHandler = () => {\n        s.parentNode?.removeChild(s)\n        s.removeEventListener('load', loadHandler, false)\n        s.removeEventListener('error', errorHandler, false)\n        console.log(\n          'ScriptDownloader:downloadScriptWeb - ' + 'Cannot load ' + url\n        )\n        reject()\n      }\n\n      s.addEventListener('load', loadHandler, false)\n      s.addEventListener('error', errorHandler, false)\n      d.body.appendChild(s)\n    })\n\n    return promise\n  }\n}\n","export default class NetworMgr {\n  public static makeRequestUrl(\n    url: string,\n    method: string,\n    params: Object = {},\n    token: string = ''\n  ): Promise<Object> {\n    return new Promise((resolve, reject) => {\n      let xhr = new XMLHttpRequest()\n      xhr.open(method, url, true)\n      xhr.setRequestHeader('Content-type', 'application/json')\n      if (token) {\n        xhr.setRequestHeader('x-access-token', token)\n      }\n      xhr.onreadystatechange = function() {\n        if (xhr.readyState !== 4) return\n        if (xhr.status >= 200 && xhr.status < 300) {\n          resolve(xhr.response)\n        } else {\n          reject({\n            status: this.status,\n            statusText: xhr.statusText,\n          })\n        }\n      }\n      xhr.onerror = function() {\n        reject({\n          status: this.status,\n          statusText: xhr.statusText,\n        })\n      }\n      if (Object.keys(params).length == 0) {\n        xhr.send()\n      } else {\n        xhr.send(JSON.stringify(params))\n      }\n    })\n  }\n}\n","/**\r\n * Copyright (c) 2022 Reson App Limited All rights reserved.\r\n * Use of this source code is governed by a BSD-style\r\n * license that can be found in the LICENSE file.\r\n */\r\n\r\nimport { Platform } from './platform'\r\nimport Config from './config.json'\r\nimport ScriptDownloader from 'component/ScriptDownloader'\r\nimport { AdsConfig } from 'defines/alldefines'\r\nimport NetworMgr from 'component/NetworkMgr'\r\n\r\nconst platform = new Platform(`ROSNInstant-${Config.version}`)\r\n\r\ndeclare var vConsole: any\r\n\r\nexport function getSDKVersion(): string {\r\n  return Config.version\r\n}\r\n\r\nexport function initializeAsync(): Promise<any> {\r\n  return new Promise(resolve => {\r\n    // platform.once('game_data_response', payload => {\r\n    //   resolve(payload)\r\n    // })\r\n    // platform.startGame()\r\n    console.log(`ROSNInstant version ${getSDKVersion()} initialize success`)\r\n    resolve({})\r\n  })\r\n}\r\n\r\n/**\r\n * @param {AdsConfig} config reward, kind of ads, num expectation\r\n * @param {Function} onSuccess trigger on view ads success\r\n * @param {Function} onFailure trigger on view ads failed\r\n **/\r\nexport function showAds(\r\n  config: AdsConfig = { adsType: 'interstitial', num: 0, rewardType: 'SCORE' },\r\n  onSuccess: (reward: Object) => void = () => {},\r\n  onFailure: () => void = () => {}\r\n) {\r\n  //validate params\r\n  const adsType =\r\n    ['reward', 'interstitial'].find(ads => ads === config.adsType) ||\r\n    'interstitial'\r\n  config.num = config.num || null\r\n\r\n  const offEvents = () => {\r\n    platform.off(`show_${adsType}_ad_success`)\r\n    platform.off(`show_${adsType}_ad_fail`)\r\n  }\r\n\r\n  const successCallback = (reward: Object) => {\r\n    offEvents()\r\n    onSuccess(reward)\r\n  }\r\n\r\n  const failureCallback = () => {\r\n    offEvents()\r\n    onFailure()\r\n  }\r\n\r\n  platform.on(`show_${adsType}_ad_success`, successCallback)\r\n  platform.on(`show_${adsType}_ad_fail`, failureCallback)\r\n  platform.showAds(config)\r\n}\r\n\r\nexport function downloadScript(scriptUrl: string): Promise<any> {\r\n  return ScriptDownloader.downloadScript(scriptUrl)\r\n}\r\n\r\nexport function closeGame() {\r\n  platform.emitCustomEvent('close_game', {})\r\n}\r\n\r\nexport function injectDebug() {\r\n  ScriptDownloader.downloadScript(\r\n    'https://unpkg.com/vconsole@3.14.6/dist/vconsole.min.js'\r\n  ).then(() => {\r\n    /*eslint-disable */\r\n        if (typeof vConsole !== 'undefined') {\r\n            const vconsole = new vConsole({ theme: 'dark' });\r\n            console.log(vconsole);\r\n        }\r\n        /*eslint-enable */\r\n  })\r\n}\r\n\r\nexport function makeRequest(\r\n  url: string,\r\n  method: string,\r\n  params: Object,\r\n  token: string\r\n): Promise<Object> {\r\n  return NetworMgr.makeRequestUrl(url, method, params, token)\r\n}\r\n"],"names":["EventWrapper","listenerManager","this","Map","_proto","addListener","eventName","listener","listeners","set","add","removeListener","get","remove","on","once","payload","_this","off","has","clear","forEach","value","key","_this2","emit","source","message","type","data","RApp","postMessage","JSON","stringify","console","log","Platform","window","document","addEventListener","removeEventListener","showAds","config","adsType","startGame","emitCustomEvent","eventWrapper","transform","event","detail","parse","ScriptDownloader","parseParameters","options","onProgress","onComplete","undefined","isCallback","Object","create","downloadScript","url","downloadScriptWeb","Promise","resolve","reject","downloaded","d","s","createElement","async","src","loadHandler","parentNode","removeChild","errorHandler","body","appendChild","NetworMgr","makeRequestUrl","method","params","token","xhr","XMLHttpRequest","open","setRequestHeader","onreadystatechange","readyState","status","response","statusText","onerror","keys","length","send","platform","scriptUrl","then","vConsole","vconsole","theme","onSuccess","onFailure","num","rewardType","find","ads","offEvents","reward"],"mappings":"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"}